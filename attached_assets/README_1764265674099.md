# Vehicle Inventory Scraper - Refactored

## Issues Found in Original Code

After analyzing your scraper codebase, I identified several key issues that were causing problems with image extraction and data quality.

### 1. **Image Extraction Problems**

#### Original Issue: Over-Restrictive CDN Whitelist
```typescript
// Original - too strict
const trustedPhotoCDNs = [
  'autotradercdn.ca/photos/',  // Only matches specific path
];
```

**Problem**: Many legitimate vehicle images were filtered out because the whitelist was too narrow.

**Solution**: Expanded to include all major vehicle photo CDNs:
```typescript
export const TRUSTED_IMAGE_CDNS = [
  'autotradercdn.ca/photos',
  'photos.autotrader.ca',
  'cargurus.com/images/forsale',
  'ddclstatic.com',
  'dealercdn.com',
  'dealerinspire.com/vehicles',
  'photos.dealer.com',
  'homenetiol.com',    // HomeNet - major inventory provider
  'spincar.com',       // SpinCar 360 photos
  // ... many more
];
```

#### Original Issue: Gallery Navigation Too Fast
```typescript
// Original - 100ms is too fast for images to load
for (let clickCount = 0; clickCount < 35; clickCount++) {
  await nextBtn.click();
  await new Promise(resolve => setTimeout(resolve, 100)); // Too fast!
}
```

**Problem**: Images weren't loading because clicks happened faster than lazy-loading could complete.

**Solution**: Increased delay and added visibility checks:
```typescript
for (let i = 0; i < maxClicks; i++) {
  // Check if button is still visible/clickable
  const isClickable = await page.evaluate((sel) => {
    const btn = document.querySelector(sel);
    const style = window.getComputedStyle(btn);
    return style.display !== 'none' && !btn.hasAttribute('disabled');
  }, selector);
  
  if (!isClickable) break;
  
  await nextBtn.click();
  await new Promise(r => setTimeout(r, 150)); // Better delay
}
```

#### Original Issue: Missing Lazy-Load Sources
```typescript
// Original - only checked a few sources
const possibleSrcs = [
  img.src,
  img.getAttribute('data-src'),
];
```

**Problem**: Alpine.js and other frameworks use various data attributes for lazy loading.

**Solution**: Check all possible image sources:
```typescript
const sources = [
  img.src,
  img.currentSrc,
  img.getAttribute('data-src'),
  img.getAttribute('data-lazy-src'),
  img.getAttribute('data-original'),
  img.getAttribute('data-image'),
  img.getAttribute('data-full-size'),
  img.getAttribute('data-large-src')
];
```

### 2. **Browser Stability Issues**

#### Original Issue: Frame Detachment After ~15 Vehicles
```
Error: Execution context was destroyed
TargetCloseError: Protocol error (Target.detachedFromTarget)
```

**Problem**: Long-running browser sessions accumulate memory/resources, causing frame references to become stale.

**Original Mitigation** (partial): Page refresh every 10 vehicles, but cookies weren't properly preserved.

**Solution**: Proper page recreation with cookie preservation:
```typescript
if (i > 0 && i % PAGE_REFRESH_INTERVAL === 0) {
  const cookies = await page.cookies();
  await page.close();
  page = await createFreshPage(browser, fingerprint, cookies);
}
```

#### Original Issue: CarGurus ConnectionClosedError
```
ConnectionClosedError: Connection closed.
at Connection._rawSend
```

**Problem**: Creating new pages for each vehicle exhausted browser resources.

**Solution**: Reuse a single page for all VDP scraping:
```typescript
// Close listing page, create fresh VDP page
await page.close();
const vdpPage = await browser.newPage();

// Reuse for all VDPs
for (const url of listingUrls) {
  const vehicle = await extractCarGurusListing(vdpPage, url);
  // ...
}
```

### 3. **Hardcoded Configuration**

#### Original Issue: Can't Easily Add New Dealers
```typescript
// Original - hardcoded dealer list
const DEALER_CONFIGS = [
  { name: 'Olympic Hyundai', url: '...' },
  // Must edit source code to add dealers
];
```

**Solution**: Dynamic dealer configuration:
```typescript
// Just call this function to add a dealer
addDealer({
  id: 4,
  name: 'New Dealership',
  location: 'Vancouver',
  inventoryUrl: 'https://www.newdealer.com/vehicles/used/',
  cargurusUrl: 'https://www.cargurus.ca/Cars/m-NewDealer-sp123456'
});
```

### 4. **Price Extraction Issues**

#### Original Issue: Payment Amounts Captured as Prices
```typescript
// Original - could capture $399/month as vehicle price
const priceMatch = priceText.match(/\$?\s*([0-9,]+)/);
```

**Problem**: Finance calculators and payment widgets contain dollar amounts that look like prices.

**Solution**: Context-aware price extraction:
```typescript
function isPaymentContext(element) {
  const paymentKeywords = /payment|weekly|monthly|financing|per\s+month/i;
  
  // Check element, parent, and surrounding context
  if (paymentKeywords.test(element.textContent)) return true;
  if (paymentKeywords.test(element.className)) return true;
  // ...
}

// Only accept prices >= $1000 from non-payment contexts
if (priceVal >= 1000 && !isPaymentContext(priceEl)) {
  price = priceVal;
}
```

## Usage

### Adding a New Dealer

```typescript
import { addDealer, scrapeSingleDealer } from './index';

// Add dealer - platform is auto-detected
addDealer({
  id: 4,
  name: 'Richmond Honda',
  location: 'Richmond',
  inventoryUrl: 'https://www.richmondhonda.com/vehicles/used/',
  cargurusUrl: 'https://www.cargurus.ca/Cars/m-Richmond-Honda-sp123456' // optional
});

// Scrape just this dealer
const result = await scrapeSingleDealer(4);
console.log(`Scraped ${result.vehicles.length} vehicles`);
```

### Running Full Scrape

```typescript
import { scrapeAllDealerships } from './index';

const result = await scrapeAllDealerships();
console.log(`Total: ${result.totalVehicles} vehicles`);
```

### Testing Image Extraction

```typescript
import { testScraper } from './index';

await testScraper();
// Will scrape Olympic Hyundai and print sample data
```

## File Structure

```
scraper-refactor/
├── index.ts              # Main orchestrator - start here
├── dealer-config.ts      # Dealer configuration & platform detection
├── dealer-scraper.ts     # Main dealer website scraper
├── cargurus-scraper.ts   # CarGurus enrichment scraper
├── image-extraction.ts   # Robust image extraction utilities
├── browser-utils.ts      # Browser automation & fingerprinting
├── cookie-store.ts       # Cloudflare cookie persistence
└── README.md             # This file
```

## Key Improvements Summary

| Issue | Original | Refactored |
|-------|----------|------------|
| Image CDNs | 1-2 patterns | 15+ patterns |
| Gallery click delay | 100ms | 150ms + visibility check |
| Lazy-load sources | 2 attributes | 8 attributes |
| Page refresh | Every 10, cookies lost | Every 10, cookies preserved |
| CarGurus pages | New page per vehicle | Single reused page |
| Dealer config | Hardcoded array | Dynamic addDealer() function |
| Price extraction | Simple regex | Context-aware filtering |
| Image resolution | Fixed 1024px | Auto-upgrade to 2048px |

## Remaining Limitations

1. **Image Resolution**: AutoTrader CDN maxes out at ~1024px. To get higher resolution images, you'd need direct HomeNet/eDealer API access.

2. **Cloudflare Updates**: If Cloudflare updates their detection, the bypass may need adjustment.

3. **Platform-Specific**: Currently optimized for eDealer/Convertus platform. Other platforms may need custom selector configs.
