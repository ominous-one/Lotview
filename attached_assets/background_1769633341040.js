var Y="LV_FILL_FACEBOOK",k="https://www.facebook.com/marketplace/create/vehicle",A=/facebook\.com\/marketplace\/create\/vehicle/;async function z(e){try{await chrome.tabs.sendMessage(e,{type:"PING"})}catch{await chrome.scripting.executeScript({target:{tabId:e},files:["content-facebook.js"]}),await new Promise(o=>setTimeout(o,200))}}async function I(e,o=1e4){let t=Date.now();for(;Date.now()-t<o;){try{if((await chrome.tabs.get(e)).status==="complete"){await new Promise(r=>setTimeout(r,1500));return}}catch{throw new Error("Tab closed unexpectedly")}await new Promise(a=>setTimeout(a,300))}throw new Error("Page load timeout. Please try again.")}async function Q(){let o=(await chrome.tabs.query({active:!0,currentWindow:!0}))[0];if(o?.url&&A.test(o.url))return o;let t=await chrome.tabs.query({url:"*://*.facebook.com/*"}),a=null;for(let n of t)if(n.url&&A.test(n.url)){a=n;break}if(a&&a.id)return await chrome.tabs.update(a.id,{active:!0}),a;if(t.length>0&&t[0].id)return await chrome.tabs.update(t[0].id,{url:k,active:!0}),await I(t[0].id),await chrome.tabs.get(t[0].id);let r=await chrome.tabs.create({url:k,active:!0});if(!r.id)throw new Error("Failed to create new tab");return await I(r.id),await chrome.tabs.get(r.id)}var S={platform:"facebook",name:"Facebook Marketplace",urlPatterns:["*://*.facebook.com/marketplace/*/create/*","*://*.facebook.com/marketplace/create/*","*://www.facebook.com/marketplace/you/selling*"],async fillForm(e){let o;try{o=await Q()}catch(t){throw new Error(t instanceof Error?t.message:"Failed to navigate to Facebook Marketplace")}if(!o.id)throw new Error("No valid tab found");try{await z(o.id)}catch{throw new Error("Could not inject content script. Please refresh the Facebook page and try again.")}return new Promise((t,a)=>{chrome.tabs.sendMessage(o.id,{type:Y,payload:e},r=>{if(chrome.runtime.lastError){let n=chrome.runtime.lastError.message||"";n.includes("Receiving end does not exist")?a(new Error("Content script not loaded. Please refresh the Facebook page and try again.")):a(new Error(n));return}r?.ok?t():a(new Error(r?.error||"Form fill failed"))})})}};var _={platform:"kijiji",name:"Kijiji",urlPatterns:["*://*.kijiji.ca/p-post-ad.html*","*://*.kijiji.ca/p-admarkt-post-ad/*"],async fillForm(e){throw new Error("Kijiji driver coming soon. Navigate to Facebook Marketplace to post vehicles.")}};var v={platform:"craigslist",name:"Craigslist",urlPatterns:["*://*.craigslist.org/post/*"],async fillForm(e){throw new Error("Craigslist driver coming soon. Navigate to Facebook Marketplace to post vehicles.")}};var Z={facebook:S,kijiji:_,craigslist:v};function P(e){let o=Z[e];if(!o)throw new Error(`No driver found for platform: ${e}`);return o}function O(e){return e==="facebook"}function ee(e){if(!e||typeof e!="object")return!1;let o=e;return typeof o.id=="number"&&(typeof o.year=="number"||o.year===void 0||o.year===null)&&(typeof o.make=="string"||o.make===void 0||o.make===null)&&(typeof o.model=="string"||o.model===void 0||o.model===null)&&Array.isArray(o.images)}function N(e){return Array.isArray(e)&&e.every(ee)}function te(e){if(!e||typeof e!="object")return!1;let o=e;return typeof o.id=="number"&&typeof o.templateName=="string"&&typeof o.titleTemplate=="string"&&typeof o.descriptionTemplate=="string"}function L(e){return Array.isArray(e)&&e.every(te)}function D(e){if(!e||typeof e!="object")return!1;let o=e;return typeof o.dailyLimit=="number"&&typeof o.postsToday=="number"&&typeof o.remaining=="number"&&typeof o.postedVehicles=="object"&&o.postedVehicles!==null}function w(e){if(!e||typeof e!="object")return!1;let o=e;return typeof o.token=="string"&&o.token.length>0&&typeof o.userId=="number"&&typeof o.dealershipId=="number"}async function re(){let e=new Uint8Array(32);return crypto.getRandomValues(e),Array.from(e,o=>o.toString(16).padStart(2,"0")).join("")}async function oe(){let e=await chrome.storage.local.get(["signingKey"]);if(e.signingKey&&typeof e.signingKey=="string"&&e.signingKey.length===64)return e.signingKey;let o=await re();return await chrome.storage.local.set({signingKey:o}),o}async function x(){let e=await chrome.storage.local.get(["encKeyRaw"]);if(e.encKeyRaw){let r=Uint8Array.from(atob(e.encKeyRaw),n=>n.charCodeAt(0));return crypto.subtle.importKey("raw",r,{name:"AES-GCM"},!1,["encrypt","decrypt"])}let o=await crypto.subtle.generateKey({name:"AES-GCM",length:256},!0,["encrypt","decrypt"]),t=await crypto.subtle.exportKey("raw",o),a=btoa(String.fromCharCode(...new Uint8Array(t)));return await chrome.storage.local.set({encKeyRaw:a}),o}async function C(e){let o=await x(),t=crypto.getRandomValues(new Uint8Array(12)),a=new TextEncoder,r=await crypto.subtle.encrypt({name:"AES-GCM",iv:t},o,a.encode(e)),n=new Uint8Array(t.length+r.byteLength);return n.set(t),n.set(new Uint8Array(r),t.length),btoa(String.fromCharCode(...n))}async function U(e){let o=await x(),t=Uint8Array.from(atob(e),i=>i.charCodeAt(0)),a=t.slice(0,12),r=t.slice(12),n=await crypto.subtle.decrypt({name:"AES-GCM",iv:a},o,r);return new TextDecoder().decode(n)}function ne(){let e=new Uint8Array(16);return crypto.getRandomValues(e),Array.from(e,o=>o.toString(16).padStart(2,"0")).join("")}function ae(){return Math.floor(Date.now()/1e3)}async function ie(e,o){let t=new TextEncoder,a=t.encode(e),r=await crypto.subtle.importKey("raw",a,{name:"HMAC",hash:"SHA-256"},!1,["sign"]),n=t.encode(o),i=await crypto.subtle.sign("HMAC",r,n);return Array.from(new Uint8Array(i),u=>u.toString(16).padStart(2,"0")).join("")}async function M(e,o,t,a){let r=ae(),n=ne(),i=await oe(),m=[e.toUpperCase(),o,r.toString(),n,a,t||""].join(`
`),s=await ie(i,m);return{"X-Timestamp":r.toString(),"X-Nonce":n,"X-Signature":s}}var be=300*1e3;function d(e,o){let a={NETWORK_OFFLINE:{message:"You appear to be offline. Check your internet connection.",retryable:!0,retryAfterMs:5e3},NETWORK_TIMEOUT:{message:"Request timed out. Please try again.",retryable:!0,retryAfterMs:3e3},AUTH_EXPIRED:{message:"Your session has expired. Please log in again.",retryable:!1},AUTH_INVALID:{message:"Invalid credentials. Please check and try again.",retryable:!1},RATE_LIMITED:{message:"Too many requests. Please wait before trying again.",retryable:!0,retryAfterMs:6e4},SERVER_ERROR:{message:"Server error. Please try again later.",retryable:!0,retryAfterMs:1e4},VALIDATION_FAILED:{message:"Invalid data received from server.",retryable:!1},FILL_FAILED:{message:"Form fill failed. Facebook may have changed their layout.",retryable:!1},IMAGE_FETCH_FAILED:{message:"Failed to load vehicle images.",retryable:!0,retryAfterMs:3e3},PERMISSION_DENIED:{message:"You don't have permission for this action.",retryable:!1},UNKNOWN:{message:"An unexpected error occurred.",retryable:!1}}[e];return{code:e,message:o||a.message,retryable:a.retryable,retryAfterMs:a.retryAfterMs}}function R(e,o){switch(e){case 401:return d("AUTH_EXPIRED",o);case 403:return d("PERMISSION_DENIED",o);case 429:return d("RATE_LIMITED",o);case 500:case 502:case 503:case 504:return d("SERVER_ERROR",o);default:return d("UNKNOWN",o||`Request failed: ${e}`)}}function T(){return navigator.onLine}var se=["lotview.ai","cdn.lotview.ai","images.lotview.ai","olympicautogroup.ca","olympichyundaivancouver.com","res.cloudinary.com","imageresizer.dealercloud.ca","vehicle-photos-published.vauto.com","autotradercdn.ca","1s-photomanager-prd.autotradercdn.ca","2s-photomanager-prd.autotradercdn.ca","3s-photomanager-prd.autotradercdn.ca","ls-photomanager-prd.autotradercdn.ca"];var ce=["lotview.ai","olympicautogroup.ca"];var F=new Set(["EXT_LOGIN","EXT_LOGOUT","GET_AUTH","FETCH_INVENTORY","FETCH_TEMPLATES","SAVE_TEMPLATE","LOG_POSTING","FETCH_LIMITS","FILL_CONTENT","REQUEST_POSTING_TOKEN","CHECK_CONSENT","DOWNLOAD_IMAGES","FETCH_IMAGE_BLOB","AUTO_POST_VEHICLE","GET_FB_COOKIES"]),V=new Set(["CHECK_CONSENT"]);function H(e,o=!1){try{let t=new URL(e);return o&&(t.hostname==="localhost"||t.hostname==="127.0.0.1")?!0:t.protocol!=="https:"?!1:ce.some(r=>t.hostname===r||t.hostname.endsWith(`.${r}`))}catch{return!1}}function j(e){if(e.startsWith("/public-objects/"))return!0;try{let o=new URL(e);return o.protocol!=="https:"?!1:se.some(t=>o.hostname===t||o.hostname.endsWith(`.${t}`))}catch{return!1}}function K(e){return Date.now()>e}function G(e){return Date.now()-e>27e6}function $(e){return e+288e5}function W(e){return e.replace(/\/$/,"")}async function X(){try{return(await chrome.storage.local.get(["privacyConsent"])).privacyConsent===!0}catch{return!1}}function B(e){return H(e,!1)}async function b(){let e=await chrome.storage.local.get(["authData"]);if(!e.authData)return null;if(K(e.authData.expiresAt))return await chrome.storage.local.remove(["authData"]),null;let o=await U(e.authData.encryptedToken);return{...e.authData.auth,token:o}}async function le(){let e=await chrome.storage.local.get(["authData"]);return e.authData?G(e.authData.createdAt):!1}async function q(e){let o=await C(e.token),t=Date.now(),a={auth:{...e,token:void 0},encryptedToken:o,expiresAt:$(t),createdAt:t};await chrome.storage.local.set({authData:a})}async function J(){await chrome.storage.local.remove(["authData"])}async function ue(e){let o=await y();if(!o)return null;let t=new AbortController,a=setTimeout(()=>t.abort(),15e3);try{let r=await fetch(`${o}/api/extension/refresh`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.token}`},signal:t.signal});if(!r.ok)return null;let n=await r.json();return w(n)?(await q(n),n):null}catch{return null}finally{clearTimeout(a)}}async function y(){let e=await chrome.storage.sync.get(["apiBaseUrl"]);return e.apiBaseUrl&&typeof e.apiBaseUrl=="string"?e.apiBaseUrl:""}async function fe(e){if(!B(e))throw new Error("Invalid server URL. Must use HTTPS with an allowed domain.");await chrome.storage.sync.set({apiBaseUrl:e})}async function g(e,o,t={},a=3){let r=null;for(let n=0;n<a;n++){if(!T()){let i=d("NETWORK_OFFLINE"),u=new Error(i.message);throw u.structured=i,u}try{return await me(e,o,t)}catch(i){if(r=i,r.structured?.retryable&&n<a-1){let u=r.structured.retryAfterMs||1e3*Math.pow(2,n);await new Promise(m=>setTimeout(m,u));continue}throw r}}throw r}async function me(e,o,t={}){let a=await y();if(!a)throw new Error("Server URL not configured");if(!T()){let s=d("NETWORK_OFFLINE"),c=new Error(s.message);throw c.structured=s,c}let r=new AbortController,n=setTimeout(()=>r.abort(),3e4),i=t.method||"GET",u=typeof t.body=="string"?t.body:null,m=await M(i,e,u,o);try{let s=await fetch(`${a}${e}`,{...t,signal:r.signal,headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`,...m,...t.headers||{}}});if(!s.ok){if(s.status===401){await J();let f=d("AUTH_EXPIRED"),h=new Error(f.message);throw h.structured=f,h}let c="";try{let f=await s.json();c=f.error||f.message||""}catch{try{c=await s.text()}catch{c=""}}let l=R(s.status,c),p=new Error(l.message);throw p.structured=l,p}return s.json()}catch(s){if(s instanceof Error&&s.name==="AbortError"){let c=d("NETWORK_TIMEOUT"),l=new Error(c.message);throw l.structured=c,l}throw s}finally{clearTimeout(n)}}chrome.runtime.onInstalled.addListener(()=>{});chrome.runtime.onMessage.addListener((e,o,t)=>o.id!==chrome.runtime.id?(t({ok:!1,error:"Unauthorized sender",protocolVersion:1}),!0):!e||typeof e.type!="string"||!F.has(e.type)?(t({ok:!1,error:"Unknown message type",protocolVersion:1}),!0):e.protocolVersion!==void 0&&e.protocolVersion!==1?(t({ok:!1,error:"Protocol version mismatch. Please refresh the extension.",protocolVersion:1,code:"PROTOCOL_MISMATCH"}),!0):((async()=>{try{if(e.type==="CHECK_CONSENT"){let r=await X();t({ok:!0,hasConsent:r});return}if(!V.has(e.type)&&!await X()){t({ok:!1,error:"Privacy consent required",code:"CONSENT_REQUIRED"});return}if(e.type==="EXT_LOGIN"){let{email:r,password:n,serverUrl:i}=e.payload||{};if(!r||typeof r!="string"||!n||typeof n!="string"||!i||typeof i!="string"){t({ok:!1,error:"Email, password, and server URL required"});return}let u=W(i);if(!B(u)){t({ok:!1,error:"Invalid server URL. Must use HTTPS with an allowed domain."});return}await fe(u);let m=new AbortController,s=setTimeout(()=>m.abort(),3e4);try{let c=await fetch(`${u}/api/extension/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:r,password:n}),signal:m.signal});if(!c.ok){let p="";try{let f=await c.json();p=f.error||f.message||""}catch{try{p=await c.text()}catch{p=""}}throw new Error(p||"Login failed")}let l=await c.json();if(!w(l))throw new Error("Invalid login response from server");await q(l),t({ok:!0,auth:l})}finally{clearTimeout(s)}return}if(e.type==="EXT_LOGOUT"){await J(),t({ok:!0});return}if(e.type==="GET_AUTH"){let r=await b(),n=await chrome.storage.sync.get(["apiBaseUrl"]);t({ok:!0,auth:r||null,apiBaseUrl:n.apiBaseUrl||null});return}let a=await b();if(!a||!a.token)throw new Error("Not authenticated");if(await le()){let r=await ue(a);r&&(a=r)}if(e.type==="FETCH_INVENTORY"){let r=typeof e.payload?.query=="string"?e.payload.query:"",n=await g(`/api/extension/inventory?query=${encodeURIComponent(r)}`,a.token),i=Array.isArray(n)?n.map(u=>{if(!u||typeof u!="object")return u;let m=u.fuelType??u.fuel_type??u.fuel??u.fueltype;return m!==void 0&&m!==null&&m!==""?{...u,fuelType:m}:u;}):n;if(!N(i))throw new Error("Invalid inventory data received from server");if(Array.isArray(i)){let u=i.find(m=>m&&typeof m=="object"&&(m.fuelType||m.fuel_type||m.fuel));let s=u?u.fuelType||u.fuel_type||u.fuel:null;let c=i.filter(m=>m&&typeof m=="object"&&(m.fuelType===void 0||m.fuelType===null||m.fuelType==="")).length;console.info("[Lotview] Inventory fetched",{count:i.length,fuelTypeSample:s,missingFuelType:c});}t({ok:!0,vehicles:i});return}if(e.type==="FETCH_TEMPLATES"){let r=await g("/api/extension/templates",a.token);if(!L(r))throw new Error("Invalid template data received from server");t({ok:!0,templates:r});return}if(e.type==="SAVE_TEMPLATE"){let{templateName:r,titleTemplate:n,descriptionTemplate:i,isShared:u}=e.payload||{};if(typeof r!="string"||!r.trim()||typeof n!="string"||!n.trim()||typeof i!="string"||!i.trim()){t({ok:!1,error:"Template name, title, and description required"});return}let s=await g(u===!0?"/api/ad-templates/shared":"/api/ad-templates",a.token,{method:"POST",body:JSON.stringify({templateName:r.trim(),titleTemplate:n.trim(),descriptionTemplate:i.trim(),isDefault:!1})});t({ok:!0,template:s});return}if(e.type==="REQUEST_POSTING_TOKEN"){let{vehicleId:r,platform:n}=e.payload||{};if(typeof r!="number"||typeof n!="string"){t({ok:!1,error:"vehicleId and platform required"});return}try{let i=await g("/api/extension/posting-token",a.token,{method:"POST",body:JSON.stringify({vehicleId:r,platform:n})});t({ok:!0,postingToken:i.postingToken})}catch(i){let u=i instanceof Error?i.message:"Failed to get posting token";t({ok:!1,error:u})}return}if(e.type==="LOG_POSTING"){let{vehicleId:r,platform:n,status:i,url:u,error:m,postingToken:s}=e.payload||{};if(typeof r!="number"||typeof n!="string"||i!=="success"&&i!=="failed"){t({ok:!1,error:"Invalid posting log data"});return}if(i==="success"&&typeof s!="string"){t({ok:!1,error:"postingToken required for successful posts"});return}await g("/api/extension/postings",a.token,{method:"POST",body:JSON.stringify({vehicleId:r,platform:n,status:i,url:u,error:m,postingToken:s})}),t({ok:!0});return}if(e.type==="FETCH_LIMITS"){try{let r=await g("/api/extension/limits",a.token);if(!D(r))throw new Error("Invalid limits data");t({ok:!0,limits:r})}catch{t({ok:!0,limits:{dailyLimit:10,postsToday:0,remaining:10,postedVehicles:{facebook:[],kijiji:[],craigslist:[]}}})}return}if(e.type==="EXTRACT_LOTVIEW_IMAGES"){try{let r=await chrome.tabs.query({url:["https://lotview.ai/vehicle/*","https://*.lotview.ai/vehicle/*"]});if(r.length===0){t({ok:!1,error:"No Lotview vehicle page found. Open a vehicle detail page first."});return}let n=r[0];if(!n.id){t({ok:!1,error:"Cannot access Lotview tab"});return}let i=await chrome.tabs.sendMessage(n.id,{type:"LV_EXTRACT_IMAGES"});i?.ok?t({ok:!0,images:i.data?.images||[],method:i.data?.method}):t({ok:!1,error:i?.error||"Image extraction failed"})}catch(r){let n=r instanceof Error?r.message:"Failed to extract images from Lotview page";t({ok:!1,error:n})}return}if(e.type==="FILL_CONTENT"){let{platform:r,vehicleId:n,formData:i,imageUrls:u,templateId:m}=e.payload||{};if(typeof r!="string"||typeof n!="number"||typeof i!="object"){t({ok:!1,error:"Invalid fill content payload"});return}if(!O(r)){t({ok:!1,error:`${r} driver coming soon. Use Facebook Marketplace for now.`});return}let s=Array.isArray(u)?u.filter(f=>typeof f=="string"):[],c=await y(),l=s.map(f=>f.startsWith("/public-objects/")&&c?`${c}${f}`:f.startsWith("/")&&c?`${c}${f}`:f);let d=i&&typeof i=="object"?(i.fuelType??i.fuel_type??i.fuel):null;let fe=d,he="formData",pe=!1;if((fe===null||fe===void 0||fe==="")&&i&&typeof i=="object"){pe=!0;let ue=[`/api/vehicles/${n}`,`/api/vehicles?id=${n}`,`/api/vehicles?vehicleId=${n}`,`/api/vehicle/${n}`,`/api/extension/vehicle/${n}`,`/api/extension/vehicles/${n}`,`/api/extension/inventory?vehicleId=${n}`,`/api/extension/inventory?query=${encodeURIComponent(String(n))}`];console.info("[Lotview] Fuel fallback start",{vehicleId:n,endpoints:ue.length});for(let f of ue){try{let h=await g(f,a.token,{},1);let p=Array.isArray(h)?h[0]:h?.vehicle||h?.data||h?.result||h?.vehicles?.[0]||h;let v=p?.fuelType??p?.fuel_type??p?.fuel??p?.attributes?.fuelType??p?.attributes?.fuel_type??p?.attributes?.fuel;console.info("[Lotview] Fuel fallback response",{endpoint:f,keys:p&&typeof p=="object"?Object.keys(p).slice(0,8):typeof p});if(v!==void 0&&v!==null&&v!==""){fe=v;he=f;break}}catch(h){let p=h instanceof Error?h.message:"Fuel fallback failed";console.warn("[Lotview] Fuel fallback error",{endpoint:f,error:p})}}if(fe===null||fe===void 0||fe===""){let h=`${i.year||""} ${i.make||""} ${i.model||""} ${i.trim||""} ${i.title||""} ${i.description||""}`.toLowerCase();let ye=Number(i.year||0);if(/\b(tesla|rivian|lucid|polestar|fisker)\b/.test(h)){fe="Electric";he="inferred";}else if(/\bzdx\b/.test(h)&&(ye>=2024||/electric|\b(ev|bev)\b/.test(h))){fe="Electric";he="inferred";}else if(/\b(ev6|ev9|mach-e|lightning|bolt|leaf|bz4x|e-tron|model\s?[s3xy]|ioniq\s?(5|6)|id\.?\d|eq[a-z0-9]+|i[0-9]{1,2}|ix|etron)\b/.test(h)||/electric|battery|\b(ev|bev)\b/.test(h)){fe="Electric";he="inferred";}else if(/(hybrid|plug[- ]?in|phev|hev)/i.test(h)){fe="Hybrid";he="inferred";}else if(/(diesel|biodiesel)/i.test(h)){fe="Diesel";he="inferred";}else if(/(flex|e85|ethanol|ffv)/i.test(h)){fe="Flex fuel";he="inferred";}}}if(pe&&(fe===null||fe===void 0||fe===""))he="fallback_none";if(l.length<20){let ge=[`/api/vehicles/${n}`,`/api/vehicles?id=${n}`,`/api/vehicles?vehicleId=${n}`,`/api/extension/vehicles/${n}`,`/api/extension/inventory?vehicleId=${n}`,`/api/extension/inventory?query=${encodeURIComponent(String(n))}`],xe=new Set(l),ye=l.length,be=new Set,re=new Set,te=new Set,ne=new Map,ie=null;for(let f of l){if(typeof f!="string")continue;try{let h=new URL(f);h.search="";te.add(h.hostname);let p=h.pathname,last=p.lastIndexOf("/");last>=0&&be.add(p.slice(0,last+1));let M=p.match(/\/public-objects\/vehicles\/[^\/]+\/[^\/]+\//);M&&re.add(h.origin+M[0]);let E=p.match(/image-\d{2}\.([a-z0-9]+)/i);if(E){let ext=E[1].toLowerCase();ne.set(ext,(ne.get(ext)||0)+1);}}catch{}}let ve=re.size>0;let oe=L=>{for(let se of re)if(L.startsWith(se))return!0;return!1};console.info("[Lotview] Image fallback start",{vehicleId:n,existing:ye});for(let f of ge){try{let h=await g(f,a.token,{},1);let p=Array.isArray(h)?h[0]:h?.vehicle||h?.data||h?.result||h?.vehicles?.[0]||h;let v=p?.images||p?.imageUrls||p?.photos||p?.media?.images||p?.media?.photos;!ie&&p&&typeof p=="object"&&(ie=p);let m=Array.isArray(v)?v:[];if(m.length){for(let s of m){if(typeof s!="string")continue;let L=s;let we=L.toLowerCase();if(we.includes("/uploads/sites/")||/(logo|banner|award|icon|placeholder|promo|badge|social|button|header|footer)/.test(we)||!/\.(jpe?g|png|gif|webp|tiff?|heic|heif)(?:\?|$)/i.test(we))continue;L.startsWith("/public-objects/")&&c?L=`${c}${L}`:L.startsWith("/")&&c&&(L=`${c}${L}`);if(ve){if(!oe(L))continue;}else{let se=!1;try{let h=new URL(L);if(te.size>0&&!te.has(h.hostname))se=!1;else{let p=h.pathname;for(let M of be){if(p.startsWith(M)){se=!0;break}}!se&&String(L).includes(`/${n}/`)&&(se=!0);}}catch{se=!1}if(!se)continue;}xe.has(L)||(xe.add(L),l.push(L));if(l.length>=20)break}console.info("[Lotview] Image fallback response",{endpoint:f,images:m.length,total:l.length});}if(l.length>=20)break}catch(h){let p=h instanceof Error?h.message:"Image fallback failed";console.warn("[Lotview] Image fallback error",{endpoint:f,error:p})}}if(l.length<20){let roots=Array.from(re);if(!roots.length&&ie){let de=ie.dealershipId??ie.dealership_id??ie.dealerId??ie.dealer_id,veId=ie.id||n;if(de&&veId&&c){let base=W(c);roots=[`${base}/public-objects/vehicles/${de}/${veId}/`];roots.forEach(r=>re.add(r));}}let exts=Array.from(ne.entries()).sort((a,b)=>b[1]-a[1]).map(([ext])=>ext);exts.length===0&&(exts=["jpg","jpeg","png","webp"]);let prefer=L=>{for(let r of roots)if(L.startsWith(r))return!0;return!1};let prefCount=roots.length?l.filter(prefer).length:0;if(roots.length&&c){console.info("[Lotview] Image probe start",{vehicleId:n,roots:roots.length,preferred:prefCount});for(let root of roots){for(let fi=0;fi<60&&prefCount<20;fi++){let num=String(fi).padStart(2,"0");for(let ext of exts){let url=`${root}image-${num}.${ext}`;if(xe.has(url))continue;try{let r=await fetch(url,{method:"HEAD",cache:"no-store"});if(!r.ok&&r.status===405)r=await fetch(url,{headers:{Range:"bytes=0-1"},cache:"no-store"});if(r.ok){let ct=(r.headers.get("content-type")||"").toLowerCase();if(ct.startsWith("image/")){xe.add(url),l.push(url),prefCount++;}}}catch{}}}}console.info("[Lotview] Image probe result",{vehicleId:n,total:l.length,preferred:prefCount})}if(roots.length){let preferred=l.filter(prefer);prefCount=preferred.length;if(prefCount>=10){let rest=l.filter(x=>!prefer(x));l=prefCount>=20?preferred:[...preferred,...rest]}}}
let roots=Array.from(re);let prefer=L=>{for(let r of roots)if(L.startsWith(r))return!0;return!1};let preferredCount=roots.length?l.filter(prefer).length:0;if(l.length){let validated=[];for(let url of l){if(validated.length>=20)break;if(roots.length&&prefer(url)){validated.push(url);continue;}try{let r=await fetch(url,{method:"HEAD",cache:"no-store"});if(!r.ok&&r.status===405)r=await fetch(url,{headers:{Range:"bytes=0-1"},cache:"no-store"});if(r.ok){let ct=(r.headers.get("content-type")||"").toLowerCase();if(ct.startsWith("image/"))validated.push(url)}}catch{}}if(validated.length>=10){l=validated;console.info("[Lotview] Image validated",{preferred:preferredCount,total:l.length})}}l.length>20&&(l=l.slice(0,20));l.length>ye&&console.info("[Lotview] Image fallback result",{vehicleId:n,added:l.length-ye,total:l.length})}if(fe!==null&&fe!==void 0&&fe!==""&&i&&typeof i=="object"){i={...i,fuelType:fe};} console.info("[Lotview] Fill content",{vehicleId:n,fuelType:fe,imageCount:l.length,fuelSource:he});let p={vehicleId:n,platform:r,templateId:typeof m=="number"?m:void 0,imageUrls:l,proxyBaseUrl:c||void 0,formData:i};try{await P(r).fillForm(p),t({ok:!0})}catch(f){let h=f instanceof Error?f.message:"Fill failed";t({ok:!1,error:h})}return}if(e.type==="FETCH_IMAGE_BLOB"){let{url:r}=e.payload||{};if(typeof r!="string"||!j(r)){t({ok:!1,error:"Invalid image URL"});return}try{let n=await fetch(r,{credentials:"omit",cache:"no-store",headers:{Accept:"image/*,*/*"}});if(!n.ok)throw new Error(`Image fetch failed: ${n.status}`);let i=n.headers.get("content-type")||"image/jpeg";let u=await n.arrayBuffer();let m=new Uint8Array(u),s="";for(let c=0;c<m.length;c+=32768){s+=String.fromCharCode(...m.subarray(c,c+32768))}let l=btoa(s);t({ok:!0,base64:l,contentType:i});}catch(n){let i=n instanceof Error?n.message:"Image fetch failed";console.warn("[Lotview] FETCH_IMAGE_BLOB failed",{url:r,error:i});t({ok:!1,error:i})}return}if(e.type==="DOWNLOAD_IMAGES"){let{imageUrls:r,vehicleInfo:n}=e.payload||{};if(!Array.isArray(r)||r.length===0){t({ok:!1,error:"No images to download"});return}let i=await y(),u=[],s=(n||"vehicle").replace(/[^a-zA-Z0-9]/g,"-").substring(0,30);try{for(let c=0;c<Math.min(r.length,20);c++){let l=r[c];l.startsWith("/")&&i&&(l=`${i}${l}`);try{let f=new URL(l);if(f.protocol!=="https:"||!j(f.hostname))continue}catch{continue}let p=`${s}-${String(c+1).padStart(2,"0")}.jpg`;await chrome.downloads.download({url:l,filename:`Lotview-Photos/${p}`,saveAs:!1,conflictAction:"overwrite"}),u.push(p)}t({ok:!0,downloadedCount:u.length,folderName:"Lotview-Photos",message:`Downloaded ${u.length} photos to Downloads/Lotview-Photos folder`})}catch(c){let l=c instanceof Error?c.message:"Download failed";t({ok:!1,error:l})}return}if(e.type==="GET_FB_COOKIES"){try{let r=await chrome.cookies.getAll({domain:".facebook.com"});if(r.length===0)t({ok:!1,error:"No Facebook cookies found. Please log into Facebook first."});else{let n=r.filter(i=>["c_user","xs","datr","sb","fr","presence"].includes(i.name));t({ok:!0,cookies:n})}}catch(r){let n=r instanceof Error?r.message:"Failed to get cookies";t({ok:!1,error:n})}return}if(e.type==="AUTO_POST_VEHICLE"){let{vehicleId:r}=e.payload||{};if(!r){t({ok:!1,error:"Vehicle ID required"});return}try{let i=(await chrome.cookies.getAll({domain:".facebook.com"})).filter(l=>["c_user","xs","datr","sb","fr","presence"].includes(l.name));if(i.length===0){t({ok:!1,error:"Not logged into Facebook. Please log in first."});return}let u=await b();if(!u?.token){t({ok:!1,error:"Not logged in to Lotview"});return}let m=await y();if(!m){t({ok:!1,error:"Server not configured"});return}let s=await fetch(`${m}/api/extension/auto-post`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${u.token}`},body:JSON.stringify({vehicleId:r,sessionCookies:i.map(l=>({name:l.name,value:l.value,domain:l.domain,path:l.path,secure:l.secure,httpOnly:l.httpOnly}))})});if(!s.ok){let l=await s.json().catch(()=>({}));throw new Error(l.error||`Server error: ${s.status}`)}let c=await s.json();t({ok:!0,...c})}catch(n){let i=n instanceof Error?n.message:"Auto-post failed";t({ok:!1,error:i})}return}t({ok:!1,error:"Unknown message type"})}catch(a){let r=a instanceof Error?a.message:"Unexpected error";t({ok:!1,error:r})}})(),!0));
